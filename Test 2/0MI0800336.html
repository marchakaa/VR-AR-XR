<!DOCTYPE html>
<html lang="en">
<head>
    <title>29. Логистичен парк (кръстосано)</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="importmap">
        {
          "imports": {
            "three": "https://unpkg.com/three@0.161.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.161.0/examples/jsm/",
            "vax": "https://boytchev.github.io/CourseVAX/lib/vax.js"
          }
        }
    </script>
</head>
<body>
    <script type="module">
        import * as THREE from "three";
        import {OrbitControls} from "three/addons/controls/OrbitControls.js";
		import * as TWEEN from "three/addons/libs/tween.module.js";
		import {vaxInitParallax, vaxInitAnaglyph, renderer, scene, light, camera} from "vax";

        vaxInitParallax(animate, -1);
        // vaxInitAnaglyph(animate);
		renderer.shadowMap.enabled = true;
		light.shadow.mapSize = new THREE.Vector2( 1024*2, 1024*2 );
		light.position.set( 0, 300, 150 );
		light.castShadow = true;
        
		let control = new OrbitControls(camera, renderer.domElement);
		control.rotateSpeed = 0.3;

        camera.position.y = 60;
        camera.rotation.x = -Math.PI/6;
        const GROUNDSIZE = 100;
        let ground = new THREE.Mesh(new THREE.BoxGeometry(GROUNDSIZE, 2, GROUNDSIZE), new THREE.MeshPhongMaterial({color: "lightgrey"}))
        ground.receiveShadow = true;
        ground.position.y = 0;
        scene.add(ground);

        function createTruck(color) {
            let truck = new THREE.Group();
            let truckBack = new THREE.Group();
            let metalMaterial = new THREE.MeshLambertMaterial({color: color})
            let l = new THREE.Mesh(new THREE.BoxGeometry(15, 1, 5), metalMaterial);
                l.receiveShadow = true;
                l.castShadow = true;
            truckBack.add(l);
            let connection = new THREE.Mesh(new THREE.BoxGeometry(3, 2, 3), metalMaterial);
                connection.position.set(8,1,0);
            truckBack.add(connection);
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 2; j++) {
                    let tire = new THREE.Group();
                    tire.position.set(-6 + i*3, 0, 3 - 6*j);
                    if(i == 2) tire.position.x = 5;
                    let rubber = new THREE.Mesh(new THREE.TorusGeometry(1, 0.5, 8, 32), new THREE.MeshLambertMaterial({color: "black"}));
                    let rim = new THREE.Mesh(new THREE.CylinderGeometry(0.7, 0.7, 0.3), new THREE.MeshLambertMaterial({color: "lightgrey"}));
                    let cap = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 0.35), new THREE.MeshLambertMaterial({color: "black"}));
                        rim.rotation.x = Math.PI/2;
                        cap.rotation.x = Math.PI/2;
                        tire.add(rubber, rim, cap);
                        rubber.castShadow = true;
                        truckBack.add(tire);    
                }
            }
            for (let i = 0; i < 2; i++) {
            let fender = new THREE.Mesh(new THREE.BoxGeometry(15, 0.2, 0.7), metalMaterial);
                fender.position.set(0, 1.6, 3 - 6*i);
                fender.castShadow = true;
            let middle = new THREE.Mesh(new THREE.BoxGeometry(5, 2, 0.75), metalMaterial);
                middle.position.set(1, 0.5, 2.875 - 2*2.875*i);
                middle.castShadow = true;
            let separator = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.5, 0.7), metalMaterial);
                separator.position.set(-4.5, 1.25, 3 - 6*i);
            truckBack.add(fender, middle, separator);
                
            }
            let back = new THREE.Mesh(new THREE.BoxGeometry(0.2, 2, 6.7), metalMaterial);
                back.position.set(-7.6, 0.5, 0)
                back.castShadow = true;
            let front = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 6.7), metalMaterial);
                front.position.set(7, 0.5, 0)
                front.castShadow = true;
            
            let cargo = new THREE.Mesh(new THREE.BoxGeometry(13, 4, 4), new THREE.MeshPhongMaterial({color: "blue"}));
                cargo.castShadow = true;
                cargo.position.y = 2.5;
            truckBack.add(back, front, cargo);

            let truckFront = new THREE.Group();
            truckFront.position.x = 13;
            let m = new THREE.Mesh(new THREE.BoxGeometry(10, 1, 5), metalMaterial);
                m.receiveShadow = true;
                m.castShadow = true;
            let m1 = new THREE.Mesh(new THREE.BoxGeometry(6, 3, 5), metalMaterial)
                m1.position.set(2, 1.5, 0);
                m1.castShadow = true;
            let glass = new THREE.Mesh(new THREE.BoxGeometry(0.3, 2, 4.8), new THREE.MeshLambertMaterial({color:'lightblue', transparent: true,opacity: 0.3}));
                glass.rotation.z = Math.PI/12;
                glass.position.x = 2;
                glass.position.y = 3.9;
            truckFront.add(m, m1, glass);
            for (let i = 0; i < 2; i++) {
                let stick = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.15, 2), metalMaterial);
                    stick.rotation.z = Math.PI/12;               
                    stick.position.set(2, 3.9, -2.35 + 4.7*i);
                    stick.castShadow = true;
                let glassDoor = new THREE.Mesh(new THREE.BoxGeometry(2, 2, 0.2), new THREE.MeshLambertMaterial({color:'lightblue', transparent: true,opacity: 0.3}));
                    glassDoor.position.set(0.6, 3.9, -2.35 + 4.7*i);
                  
                let fender = new THREE.Mesh(new THREE.BoxGeometry(10, 0.2, 0.7), metalMaterial);
                    fender.position.set(0, 1.6, 3 - 6*i);
                let middle = new THREE.Mesh(new THREE.BoxGeometry(3, 2, 0.75), metalMaterial);
                    middle.position.set(0, 0.5, 2.875 - 2*2.875*i);
                let backFender = new THREE.Mesh(new THREE.BoxGeometry(0.5, 2, 0.75), metalMaterial);
                    backFender.position.set(-4.75, 0.5, 2.875 - 2*2.875*i);
                let frontFender = new THREE.Mesh(new THREE.BoxGeometry(0.7, 2, 0.75), metalMaterial);
                    frontFender.position.set(4.8, 0.5, 2.875 - 2*2.875*i);
                let headLights = new THREE.Mesh(new THREE.SphereGeometry(0.35), new THREE.MeshBasicMaterial({color:"white"}));
                    headLights.position.set(5, 1, 2.875 - 2*2.875*i);
                let pointLight = new THREE.PointLight(0xFFFFFF, 6, 100);
                pointLight.position.x = 0.12;
                headLights.add(pointLight);
                truckFront.add(stick, glassDoor, fender, middle, backFender, frontFender, headLights);
                
            }
            let back2 = new THREE.Mesh(new THREE.BoxGeometry(0.6, 2, 5), metalMaterial);
                back2.castShadow = true;
                back2.position.set(-0.7, 3.9, 0);
            let top = new THREE.Mesh(new THREE.BoxGeometry(3, 0.5, 5), metalMaterial);
                top.castShadow = true;
                top.position.set(0.5, 5, 0);
            let frontArmor = new THREE.Mesh(new THREE.BoxGeometry(0.2, 3, 5), new THREE.MeshLambertMaterial({color: "lightgrey"}));
                frontArmor.position.set(5, 1, 0);

            truckFront.add(back2, top, frontArmor);  
            for (let i = 0; i < 2; i++) {
                for (let j = 0; j < 2; j++) {
                    let tire = new THREE.Group();
                    tire.position.set(-3 + i*6, 0, 3 - 6*j);
                    if(i == 2) tire.position.x = 5;
                    let rubber = new THREE.Mesh(new THREE.TorusGeometry(1, 0.5, 8, 32), new THREE.MeshLambertMaterial({color: "black"}));
                    let rim = new THREE.Mesh(new THREE.CylinderGeometry(0.7, 0.7, 0.3), new THREE.MeshLambertMaterial({color: "lightgrey"}));
                    let cap = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 0.35), new THREE.MeshLambertMaterial({color: "black"}));
                        rim.rotation.x = Math.PI/2;
                        cap.rotation.x = Math.PI/2;
                        tire.add(rubber, rim, cap);
                        rubber.castShadow = true;
                        truckFront.add(tire);    
                }
            }
            truck.add(truckBack, truckFront);
            truck.position.y = 1;
            return truck;
        }
        function createHangar() {
            let hangarMaterial = new THREE.MeshPhongMaterial({color: "yellow"});
            let building = new THREE.Group();
            //70,50,50
            let frontWall1 = new THREE.Mesh(new THREE.BoxGeometry(25, 15, 2), hangarMaterial);
            let frontWall2 = frontWall1.clone();
                frontWall2.position.set(47.5,0,0);
            let backWall = new THREE.Mesh(new THREE.BoxGeometry(72.5, 15, 2), hangarMaterial);
                backWall.position.set(23.75, 0, -39);
            let rightWall = new THREE.Mesh(new THREE.BoxGeometry(2, 15, 37), hangarMaterial);
                rightWall.position.set(59, 0, -19.5);
            let leftWall = new THREE.Mesh(new THREE.BoxGeometry(2, 15, 22), hangarMaterial);
                leftWall.position.set(-11.5, 0, -12);
            let mainDoor = new THREE.Mesh(new THREE.BoxGeometry(22.5, 5, 1), new THREE.MeshLambertMaterial({color: "lightgrey"}));
                mainDoor.position.set(23.75, 5, 0);
            let secondDoor = new THREE.Mesh(new THREE.BoxGeometry(1, 15, 17), new THREE.MeshLambertMaterial({color: "lightgrey"}));
                secondDoor.position.set(-13, 0, -30);
            let block = new THREE.Mesh(new THREE.BoxGeometry(72.5, 25, 41), hangarMaterial);
                block.position.set(23.75,20,-19.5);
            let t = new THREE.Mesh(new THREE.CylinderGeometry(1, 1, 41), hangarMaterial);
                t.rotation.x = Math.PI/2;
                t.position.set(-12.5, 8, -19.5);
            let light1 = new THREE.Mesh(new THREE.SphereGeometry(1), new THREE.MeshBasicMaterial({color: 0xFFFFFF}));
                light1.position.set(-12.5, 11, -23);
            let pointLight = new THREE.PointLight(0xFFFFFF, 12, 100);
                light1.add(pointLight);
            let light2 = new THREE.Mesh(new THREE.SphereGeometry(1), new THREE.MeshBasicMaterial({color: 0xFFFFFF}));
                light2.position.set(-12.5, 11, -38);
            let pointLight2 = new THREE.PointLight(0xFFFFFF, 12, 100);
                light2.add(pointLight2);

            let text = new THREE.Group();
            let textMaterial = new THREE.MeshLambertMaterial({color: 0xEE0000});
            let d1 = new THREE.Mesh(new THREE.BoxGeometry(3, 13, 0.2), textMaterial);
            let d2 = new THREE.Mesh(new THREE.BoxGeometry(5, 3, 0.2), textMaterial);
                d2.position.set(4,5,0);
            let d3 = d2.clone();
                d3.position.set(4, -5, 0);
            let d4 = new THREE.Mesh(new THREE.BoxGeometry(3, 10, 0.2), textMaterial);
                d4.position.set(8, 0, 0);
            let h1 = d1.clone();
                h1.position.x = 13;
            let h2 = h1.clone();
                h2.position.x = 20;
            let h3 = d2.clone();
                h3.position.set(16, 0, 0);
            let l1 = h1.clone();
                l1.position.x = 25;
            let l2 = d3.clone();
                l2.position.x = 29;
            text.add(d1, d2, d3, d4, h1, h2, h3, l1, l2);
            text.position.set(8,23,1);
            building.add(frontWall1, frontWall2, backWall, rightWall, leftWall, mainDoor, secondDoor, block, t, text, light1, light2);
            return building;
        }
        let hangar1 = createHangar();
        hangar1.position.set(-10, 8.5, -10);
        let barrier = new THREE.Mesh(new THREE.CylinderGeometry(1,1, 5), new THREE.MeshLambertMaterial({color:"black"}));
            barrier.castShadow = true;    
            barrier.position.set(-20, 3, 0);
        let sphere1 = new THREE.Mesh(new THREE.SphereGeometry(1), new THREE.MeshBasicMaterial({color: "red"}));
            sphere1.position.set(-20, 5.5,0);
        let barrierMoveable = new THREE.Mesh(new THREE.CylinderGeometry(0.5,0.5, 15), new THREE.MeshLambertMaterial({color:"white"}));
            barrierMoveable.castShadow = true;
            barrierMoveable.rotation.x += Math.PI/2;
            barrierMoveable.position.set(-20, 3, 8);
            // barrierMoveable.position.set(-20, 13, 0);
        let wall1 = new THREE.Mesh(new THREE.BoxGeometry(1, 5, 8), new THREE.MeshLambertMaterial({color: 'grey'}));
            wall1.castShadow = true;
            wall1.position.set(-20, 3, -5);
        let wall2 = new THREE.Mesh(new THREE.BoxGeometry(1, 5, 35), new THREE.MeshLambertMaterial({color: 'grey'}));
            wall2.castShadow = true;
            wall2.position.set(-20, 3, 32.5);
        for (let i = 0; i < 6; i++) {
            let whiteStripe = new THREE.Mesh(new THREE.BoxGeometry(1, 0.02, 10), new THREE.MeshLambertMaterial({color: "white"}));
                whiteStripe.position.set(-35, 1.01, -40 + i*16); 
            scene.add(whiteStripe);
        }    
        for (let i = 0; i < 5; i++) {
            let parkingStripes = new THREE.Mesh(new THREE.BoxGeometry(1, 0.02, 30), new THREE.MeshLambertMaterial({color: "white"}));
                parkingStripes.position.set(-10+12*i, 1.01, 35);
            scene.add(parkingStripes);
        }   
        scene.add(barrier, barrierMoveable, wall1, wall2, sphere1);
        let truck1 = createTruck("orange");
            truck1.position.y = 2.5;
        let truck2 = createTruck("red");
            truck2.rotation.y = -Math.PI/2;
            truck2.position.set(8,2.5,30);
        let truck3 = createTruck("white");
            truck3.position.set(0,2.5,0);
            truck3.rotation.y = -Math.PI/2;
            truck3.position.set(-4,2.5,30);
        scene.add(truck2, truck3);
        let tween = new TWEEN.Tween(hangar1.children[6].position).to({z:-13}, 2000).start();
        let tween1 = new TWEEN.Tween(hangar1.children[6].position).to({z:-13}, 4000);
        let tween2 = new TWEEN.Tween(hangar1.children[6].position).to({z:-30}, 2000);
        let tween3 = new TWEEN.Tween(hangar1.children[6].position).to({z:-30}, 20000);
            tween.chain(tween1);
            tween1.chain(tween2);
            tween2.chain(tween3);
            tween3.chain(tween);
        let tweenBarrierMoveable = new TWEEN.Tween(barrierMoveable.position).to({z:8, y:3}, 5000).onComplete(() => {
            sphere1.material.color = new THREE.Color("lightgreen");
        }).start();
        let tweenBarrierMoveable1 = new TWEEN.Tween(barrierMoveable.position).to({z:0, y:13}, 2000);
        let tweenBarrierMoveable2 = new TWEEN.Tween(barrierMoveable.position).to({z:0, y:13}, 4000).onComplete(() => {
            sphere1.material.color = new THREE.Color("red");
        });
        let tweenBarrierMoveable3 = new TWEEN.Tween(barrierMoveable.position).to({z:8, y:3}, 2000);
        let tweenBarrierMoveable4 = new TWEEN.Tween(barrierMoveable.position).to({z:8, y:3}, 15000);
            tweenBarrierMoveable.chain(tweenBarrierMoveable1);
            tweenBarrierMoveable1.chain(tweenBarrierMoveable2);
            tweenBarrierMoveable2.chain(tweenBarrierMoveable3);
            tweenBarrierMoveable3.chain(tweenBarrierMoveable4);
            tweenBarrierMoveable4.chain(tweenBarrierMoveable);
        let tweenBarrierMoveableRot = new TWEEN.Tween(barrierMoveable.rotation).to({x:Math.PI/2}, 5000).start();
        let tweenBarrierMoveableRot1 = new TWEEN.Tween(barrierMoveable.rotation).to({x:0}, 2000);
        let tweenBarrierMoveableRot2 = new TWEEN.Tween(barrierMoveable.rotation).to({x:0}, 4000);
        let tweenBarrierMoveableRot3 = new TWEEN.Tween(barrierMoveable.rotation).to({x:Math.PI/2}, 2000);
        let tweenBarrierMoveableRot4 = new TWEEN.Tween(barrierMoveable.rotation).to({x:Math.PI/2}, 15000);
            tweenBarrierMoveableRot.chain(tweenBarrierMoveableRot1);
            tweenBarrierMoveableRot1.chain(tweenBarrierMoveableRot2);
            tweenBarrierMoveableRot2.chain(tweenBarrierMoveableRot3);
            tweenBarrierMoveableRot3.chain(tweenBarrierMoveableRot4);
            tweenBarrierMoveableRot4.chain(tweenBarrierMoveableRot);
        
        
        truck1.rotation.y = Math.PI;
        truck1.position.z = -41;
        let cargosStored = [];
        let tweenTruckMovement0 = new TWEEN.Tween(truck1.position).to({x:0}, 2000).start();
        let tweenTruckMovement1 = new TWEEN.Tween(truck1.position).to({x:-16}, 1000);
        let tweenTruckMovement2 = new TWEEN.Tween(truck1.position).to({x:-44,z:-20}, 2000);
        let tweenTruckMovement21 = new TWEEN.Tween(truck1.position).to({x:-44,z:-15}, 500);
        let tweenTruckMovement3 = new TWEEN.Tween(truck1.position).to({x:-30,z:8}, 2000);
        let tweenTruckMovement4 = new TWEEN.Tween(truck1.position).to({x:30,z:8}, 2000);
        let tweenTruckMovement5 = new TWEEN.Tween(truck1.position).to({x:20,z:0}, 2000);
        let tweenTruckMovement6 = new TWEEN.Tween(truck1.position).to({x:20,z:-35}, 2000).onComplete(() => {
            let cargo = truck1.children[0].children[truck1.children[0].children.length - 1];
            truck1.children[0].children.pop();
            cargo.position.set(40, 2.5 + 4.1*(cargosStored.length%5), -17 -4.1*(Math.floor(cargosStored.length/5)));
            scene.add(cargo);
            cargosStored.push(cargo);
        });
        let tweenTruckMovement7 = new TWEEN.Tween(truck1.position).to({x:20,z:-35}, 2000);
        let tweenTruckMovement8 = new TWEEN.Tween(truck1.position).to({x:20,z:30}, 2000);
        let tweenTruckMovement81 = new TWEEN.Tween(truck1.position).to({x:20,z:30}, 2000);
        let tweenTruckMovement9 = new TWEEN.Tween(truck1.position).to({x:40,z:15}, 2000);
        let tweenTruckMovement10 = new TWEEN.Tween(truck1.position).to({x:20,z:-5}, 2000);
        let tweenTruckMovement101 = new TWEEN.Tween(truck1.position).to({x:20,z:-15}, 500);
        let tweenTruckMovement11 = new TWEEN.Tween(truck1.position).to({x:0,z:-41}, 2000).onComplete(() => {
            let cargo = new THREE.Mesh(new THREE.BoxGeometry(13, 4, 4), new THREE.MeshPhongMaterial({color: new THREE.Color().setHSL(THREE.MathUtils.randFloat(0, 1), 1, 0.5)}));
                cargo.castShadow = true;
                cargo.position.y = 2.5;
            truck1.children[0].add(cargo);
        });
        let tweenTruckMovement12 = new TWEEN.Tween(truck1.position).to({x:0,z:-41}, 2000);
            tweenTruckMovement0.chain(tweenTruckMovement1); 
            tweenTruckMovement1.chain(tweenTruckMovement2); 
            tweenTruckMovement2.chain(tweenTruckMovement21);
            tweenTruckMovement21.chain(tweenTruckMovement3);
            tweenTruckMovement3.chain(tweenTruckMovement4);
            tweenTruckMovement4.chain(tweenTruckMovement5);
            tweenTruckMovement5.chain(tweenTruckMovement6);
            tweenTruckMovement6.chain(tweenTruckMovement7);
            tweenTruckMovement7.chain(tweenTruckMovement8);
            tweenTruckMovement8.chain(tweenTruckMovement81);
            tweenTruckMovement81.chain(tweenTruckMovement9);
            tweenTruckMovement9.chain(tweenTruckMovement10);
            tweenTruckMovement10.chain(tweenTruckMovement101);
            tweenTruckMovement101.chain(tweenTruckMovement11);
            tweenTruckMovement11.chain(tweenTruckMovement12);
            tweenTruckMovement12.chain(tweenTruckMovement0);
        let tweenTruckRotation0 = new TWEEN.Tween(truck1.rotation).to({y: 1*Math.PI}, 2000).start();
        let tweenTruckRotation1 = new TWEEN.Tween(truck1.rotation).to({y: Math.PI}, 1000);
        let tweenTruckRotation2 = new TWEEN.Tween(truck1.rotation).to({y: 3*Math.PI/2}, 2000);
        let tweenTruckRotation21 = new TWEEN.Tween(truck1.rotation).to({y: 3*Math.PI/2}, 500);
        let tweenTruckRotation3 = new TWEEN.Tween(truck1.rotation).to({y: 4*Math.PI/2}, 2000);
        let tweenTruckRotation4 = new TWEEN.Tween(truck1.rotation).to({y: 4*Math.PI/2}, 2000);
        let tweenTruckRotation5 = new TWEEN.Tween(truck1.rotation).to({y: 3*Math.PI/2}, 2000);
        let tweenTruckRotation6 = new TWEEN.Tween(truck1.rotation).to({y: 3*Math.PI/2}, 2000);
        let tweenTruckRotation7 = new TWEEN.Tween(truck1.rotation).to({y: 3*Math.PI/2}, 2000);
        let tweenTruckRotation8 = new TWEEN.Tween(truck1.rotation).to({y: 3*Math.PI/2}, 2000);
        let tweenTruckRotation81 = new TWEEN.Tween(truck1.rotation).to({y: 3*Math.PI/2}, 2000);
        let tweenTruckRotation9 = new TWEEN.Tween(truck1.rotation).to({y: 2*Math.PI/2}, 2000);
        let tweenTruckRotation10 = new TWEEN.Tween(truck1.rotation).to({y: 1*Math.PI/2}, 2000);
        let tweenTruckRotation101 = new TWEEN.Tween(truck1.rotation).to({y: 1*Math.PI/2}, 500);
        let tweenTruckRotation11 = new TWEEN.Tween(truck1.rotation).to({y: 2*Math.PI/2}, 2000);
        let tweenTruckRotation12 = new TWEEN.Tween(truck1.rotation).to({y: 2*Math.PI/2}, 2000);
            tweenTruckRotation0.chain(tweenTruckRotation1);
            tweenTruckRotation1.chain(tweenTruckRotation2);
            tweenTruckRotation2.chain(tweenTruckRotation21);
            tweenTruckRotation21.chain(tweenTruckRotation3);
            tweenTruckRotation3.chain(tweenTruckRotation4);
            tweenTruckRotation4.chain(tweenTruckRotation5);
            tweenTruckRotation5.chain(tweenTruckRotation6);
            tweenTruckRotation6.chain(tweenTruckRotation7);
            tweenTruckRotation7.chain(tweenTruckRotation8);
            tweenTruckRotation8.chain(tweenTruckRotation81);
            tweenTruckRotation81.chain(tweenTruckRotation9);
            tweenTruckRotation9.chain(tweenTruckRotation10);
            tweenTruckRotation10.chain(tweenTruckRotation101);
            tweenTruckRotation101.chain(tweenTruckRotation11);
            tweenTruckRotation11.chain(tweenTruckRotation12);
            tweenTruckRotation12.chain(tweenTruckRotation0);
        scene.add(truck1, hangar1);
        function animate(t) {
			TWEEN.update();
            // truck1.rotation.y  = t;
            // ground.rotation.y = t;
        }
    </script>
</body>
</html>