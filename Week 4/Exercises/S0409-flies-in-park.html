<!DOCTYPE html>

<html>
	<head>
		<title>S0409: Мушички в парка</title>
		<meta charset="utf-8">
		
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		
		<script type="importmap">
		  {
			"imports": {
			  "three": "https://unpkg.com/three@0.161.0/build/three.module.js",
			  "three/addons/": "https://unpkg.com/three@0.161.0/examples/jsm/",
			  "vax": "https://boytchev.github.io/CourseVAX/lib/vax.js"
			}
		  }
		</script>
	</head>
	
	<body>
		<script type="module">
		
			// ---------------------------------------------
			// Тук е само началото на решението. Може да го
			// ползвате, ако искате да си спестите писането
			// на периферен код. Ако силно желаете да имате
			// опит с Three.js, по-добре започнете начисто.
			// ---------------------------------------------		
		
			import * as THREE from "three";
			import {vaxSceneInit, Pillar, renderer, light, ambientLight, spotLight, camera, scene, object} from "vax";

			vaxSceneInit(animate);

			// изключваме няколко светлини
			scene.background = new THREE.Color('black');
			light.intensity = 0;
			ambientLight.intensity = 0;

			// правим втора прожекторна светлина, която не прави сянка
			var secondSpotLight = spotLight.clone();
				secondSpotLight.intensity = 1;
				secondSpotLight.angle = 0.6;
				secondSpotLight.position.x = -40;
				secondSpotLight.castShadow = false;
				secondSpotLight.target = new THREE.Object3D();
				secondSpotLight.target.position.set(-40, 0, 0);
			scene.add(secondSpotLight);
			scene.add(secondSpotLight.target);

			// и трета
			var thirdSpotLight = spotLight.clone();
				thirdSpotLight.intensity = 1;
				thirdSpotLight.angle = 0.6;
				thirdSpotLight.position.x = 40;
				thirdSpotLight.castShadow = false;
				thirdSpotLight.target = new THREE.Object3D();
				thirdSpotLight.target.position.set(40, 0, 0);
			scene.add(thirdSpotLight);
			scene.add(thirdSpotLight.target);

			// главната прожекторна светлина е слаба,
			// за да са сенките достатъчно бледи
			spotLight.shadow.radius = 4;
			spotLight.intensity = 1;

			// две лампи
			var lamp1 = new THREE.Mesh(
					new THREE.SphereGeometry(5),
					new THREE.MeshLambertMaterial({
						color: 'yellow',
						emissive: 'lightyellow',
						emissiveIntensity: 0.5
					})
				);
			lamp1.position.set(-40, 60, 0);
			scene.add(lamp1);

			var lamp2 = lamp1.clone();
			lamp2.position.x = 40;
			scene.add(lamp2);

			// стълб на лампата
			var lampPillar1 = new Pillar(lamp1.position);
			lampPillar1.scale.set(0.5, 1, 0.5);
			scene.add(lampPillar1);

			var lampPillar2 = new Pillar(lamp2.position);
			lampPillar2.scale.set(0.5, 1, 0.5);
			scene.add(lampPillar2);

			// мухи
			scene.remove(object);
			var n = 60; // брой мухи
			var flies = [];

			// създаване на n мухи
			for (var i = 0; i < n; i++)
			{
				var fly = new THREE.Mesh(
						new THREE.IcosahedronGeometry(0.4),
						new THREE.MeshLambertMaterial({
							color: 'yellow',
							emissive: 'white',
							emissiveIntensity: 0.5
						})
					);
				fly.castShadow = true;
				fly.offset = 2*Math.PI*Math.random();
				flies.push(fly);
				scene.add(fly);
			}
			
			// Изчисляване на движението
			// pos = new THREE.Vector3();
			fly = flies[0];
			console.log((fly.position.setFromSphericalCoords(20 + 10*Math.sin(0.8*3), Math.PI/2, 2*3+fly.offset).add(lamp2.position)))
			// Define the spherical coordinates
			var radius = 20 + 10 * Math.sin(0.8 * 3); // Example values for radius, phi, and theta
			var phi = Math.PI / 2;
			var theta = 2 * 3 + fly.offset;

			// Calculate the position using setFromSphericalCoords
			var position = new THREE.Vector3().setFromSphericalCoords(radius, phi, theta).add(lamp2.position);
			console.log(position)


			function animate(t)
			{

				for (var i = 0; i < n; i++)
				{
					// console.log(t);
					fly = flies[i];

					let radius = 20 + 10*Math.sin(0.8*t+i*i);
					let height = 60 + 10*Math.sin(2.1*t-i);
					let phi = Math.PI/2;
					let theta = 2*t + fly.offset;

					// позиция на мухата
					if(t % 6 <= 2) {
						fly.position.setFromSphericalCoords(radius, phi, theta).add(lamp1.position);
					} else if(t % 6 <= 3) {
						let targetPosition = new THREE.Vector3().setFromSphericalCoords(radius, phi, theta).add(lamp2.position);
						let movementVector = targetPosition.sub(fly.position).divideScalar(4);
						fly.position.add(movementVector);
						// fly.position.x += 2.25;
						
						// console.log(123);
					} else if(t % 6 <= 5) {
						fly.position.setFromSphericalCoords(radius, phi, theta).add(lamp2.position);
					} else {
						// fly.position.x -= 2.25;
						let targetPosition = new THREE.Vector3().setFromSphericalCoords(radius, phi, theta).add(lamp1.position);
						let movementVector = targetPosition.sub(fly.position).divideScalar(4);
						fly.position.add(movementVector);
						// console.log(456);
					}
					fly.position.y = height;
				}

				scene.rotation.y = t/5;
			}
			
		</script>
	</body>
</html>


